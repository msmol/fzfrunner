#!/usr/bin/env bash

# make sure working dir is always directory of script itself
cd "$(dirname "${BASH_SOURCE[0]}")"
ALT_PREFIX="ALT::"

read -r -d '' PY_PRINT <<EOM
import sys

try:
    print(eval(sys.argv[1]))
except:
    pass
EOM

FZF_LIST=""

for f in ./runners/*
do
  source "$f"
  FZF_LIST="${FZF_LIST}$(get_list)"
done

SELECTED=$(echo "${FZF_LIST}" |
  fzf \
    --print-query \
    --preview-window=down:1 \
    --preview "python <(printf '%s\n' \"${PY_PRINT}\") {q}" \
    --bind "alt-enter:execute(echo ${ALT_PREFIX}{})+accept")

if [[ "${SELECTED}" =~ ^"${ALT_PREFIX}" ]]; then
  SELECTED=$(echo "${SELECTED}" | head -n1 | sed "s/^${ALT_PREFIX}//")
  ALT=1
else
  SELECTED=$(echo "${SELECTED}" | tail -n1)
  ALT=0
fi

for f in ./runners/*
do
	source "${f}"
	if [[ "${SELECTED}" =~ ^"$(get_prefix)" ]]; then
    handle "${SELECTED}" "${ALT}"
    exit 0
  fi
done
